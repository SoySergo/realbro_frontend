# Улучшения системы фильтров локации

## Реализованные изменения

### 1. **Три кнопки управления** (LocationModeActions)
Новый универсальный компонент кнопок для всех режимов:

- **Очистить** - очищает только локальное состояние текущего режима
- **Выйти** - закрывает панель (с предупреждением если есть несохранённые данные)
- **Применить** - применяет данные в store и закрывает панель (с предупреждением если есть данные в других режимах)

**Файл**: `src/components/features/search/location-details/LocationModeActions.tsx`

### 2. **Алерты подтверждения**
Используется `AlertDialog` из shadcn/ui для предупреждений:

#### При выходе с несохранёнными данными:
```
Заголовок: "Выйти без сохранения?"
Описание: "У вас есть несохранённые изменения в режиме "{mode}". Они будут потеряны."
Кнопки: "Отмена" | "Всё равно выйти"
```

#### При применении с потерей данных других режимов:
```
Заголовок: "Применить фильтр?"
Описание: "Будут применены данные из режима "{currentMode}". Данные из режимов: {otherModes} — будут проигнорированы."
Кнопки: "Отмена" | "Применить"
```

### 3. **Клик по полигону на карте**
Обновлён `BoundariesLayer.tsx`:

- **До**: клик добавлял полигон напрямую в глобальный store
- **После**: клик добавляет/удаляет полигон в локальное состояние (toggle)

**Логика toggle**:
- Если полигон не выбран → добавляется в локальное состояние
- Если полигон уже выбран → удаляется из локального состояния
- Применение в глобальный фильтр — только по кнопке "Применить"

### 4. **Подсветка полигонов**
Карта теперь подсвечивает полигоны из двух источников:
- Локальное состояние (временные выборы)
- Глобальное состояние (применённые фильтры)

### 5. **Закрытие панели после применения**
После успешного применения фильтра:
- Локальное состояние очищается
- Панель деталей закрывается (`setLocationMode(null)`)
- Пользователь возвращается к обычному виду

### 6. **Проверка данных в других режимах**
Новые методы в `useLocalLocationState`:

```typescript
hasDataInMode(mode): boolean
// Проверяет наличие данных в конкретном режиме

getModesWithData(excludeMode?): LocationFilterMode[]
// Возвращает список режимов с данными (кроме исключённого)
```

## Локализация

Добавлены ключи в `messages/*.json`:

```json
{
  "exit": "Выйти",
  "cancel": "Отмена",
  "exitConfirmTitle": "Выйти без сохранения?",
  "exitConfirmDescription": "У вас есть несохранённые изменения...",
  "exitAnyway": "Всё равно выйти",
  "applyConfirmTitle": "Применить фильтр?",
  "applyConfirmDescription": "Будут применены данные из режима...",
  "applyAnyway": "Применить"
}
```

## Пользовательские сценарии

### Сценарий 1: Выбор через инпут
```
1. Пользователь вводит "Барселона" в инпут поиска
2. Выбирает из выпадающего списка
3. Локация добавляется в локальное состояние (не в store)
4. Пользователь нажимает "Применить"
5. Локация применяется в store → запускается поиск
6. Панель закрывается
```

### Сценарий 2: Клик по карте
```
1. Пользователь кликает на полигон Барселоны
2. Полигон подсвечивается → добавлен в локальное состояние
3. Пользователь кликает повторно
4. Подсветка снимается → удалён из локального состояния
5. Пользователь кликает снова → снова добавлен
6. Нажимает "Применить" → применяется в store
```

### Сценарий 3: Выход с несохранёнными данными
```
1. Пользователь выбрал 2 локации
2. Нажимает "Выйти"
3. Показывается алерт: "Выйти без сохранения?"
4. Пользователь выбирает:
   - "Отмена" → остаётся в режиме
   - "Всё равно выйти" → панель закрывается, данные теряются
```

### Сценарий 4: Переключение между режимами
```
1. Пользователь в режиме "Поиск", выбрал 2 локации
2. Переключается на "Рисование"
3. Нарисовал полигон
4. Нажимает "Применить"
5. Показывается алерт: "Данные из режима 'Поиск' будут проигнорированы"
6. Пользователь выбирает:
   - "Отмена" → возвращается к редактированию
   - "Применить" → применяются только данные из "Рисование"
```

### Сценарий 5: Очистка
```
1. Пользователь выбрал несколько локаций
2. Нажимает "Очистить"
3. Локальное состояние очищается
4. Полигоны на карте теряют подсветку
5. Панель остаётся открытой для нового выбора
```

## Технические детали

### Поток данных

```
Инпут/Карта → localStorage (локальный слой)
                    ↓
              Кнопка "Применить"
                    ↓
           filterStore (глобальный слой)
                    ↓
              API запрос → Результаты
```

### Состояние полигонов на карте

```typescript
allSelectedWikidata = 
    localState.selectedLocations.wikidata 
    + 
    store.selectedBoundaryWikidata
```

Карта подсвечивает полигоны из обоих источников одновременно.

## Файлы изменений

| Файл | Изменения |
|------|-----------|
| `LocationModeActions.tsx` | **Создан** - компонент 3 кнопок с алертами |
| `LocationSearchMode.tsx` | Интегрирован LocationModeActions |
| `BoundariesLayer.tsx` | Toggle логика при клике, подсветка из 2 источников |
| `useLocalLocationState.ts` | Добавлены `hasDataInMode`, `getModesWithData` |
| `messages/*.json` | Добавлены ключи для алертов и кнопок |
| `alert-dialog.tsx` | **Создан** - компонент из shadcn/ui |

## Будущие улучшения

- [ ] Применить ту же логику к режимам Draw, Isochrone, Radius
- [ ] Добавить иконки в алерты для наглядности
- [ ] Сохранять выбор пользователя "не показывать снова" для алертов
- [ ] Анимация при переключении между режимами
- [ ] Подсказки (tooltips) для кнопок
